name: CI

on:
  push:
    branches:
      - "**" #double star includes a '/'.  single star doesnt match a '/'
    tags:
      - "**" #double star includes a '/'.  single star doesnt match a '/'
  schedule:
    # Daily at 05:44
    - cron: '44 5 * * *'

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: 3.7

jobs:
  build:
    name: CI
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: recursive
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Poetry and Venv
        run: |
          python3 -m ensurepip
          python3 -m pip install --upgrade pip
          python3 -m pip install poetry
          poetry config virtualenvs.in-project true
          poetry config virtualenvs.path .
          poetry install
      - name: python commands
        run: |
          set -vx
          poetry env
          buildui
          poetry-dynamic-versioning
          which pip
          pip --version
          #python boots.py create --group test

          black --exclude=.\.venv --check --diff .
          python -c "import sys; print(sys.version)"

          pip freeze --all
          genbuildinfo "src/epcpm/__build.py"
          generateversion --distribution epcpm --out "src/epcpm/__version.py"

          pyinstaller pyinstaller.spec
          mv "dist/epcpm" "EPCPM_${GITHUB_RUN_ID}_${GITHUB_RUN_NUMBER}"
          7z a "EPCPM_${GITHUB_RUN_ID}_${GITHUB_RUN_NUMBER}.zip" "EPCPM_${GITHUB_RUN_ID}_${GITHUB_RUN_NUMBER}"


          mkdir artifacts
          mv *.zip artifacts/

          rm -rf dist
          poetry build
          #python boots.py build
          mv dist/* artifacts/

          pytest epcpm.tests --pyargs

          #python boots.py publish

          exit

      - name: Archive artifacts
        uses: actions/upload-artifact@v2
        with:
          name: pm
          path: |
            artifacts/*
